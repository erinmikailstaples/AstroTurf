name: Astroturf: Synthetic Grassroots Maintenance

on:
  schedule:
    - cron: '17 5 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  astroturf:
    name: Turf the Narrative (Totally Organic)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (rolling out the green carpet)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Set up Bot Persona (very human, definitely)
        run: |
          git config user.name "Astroturf Bot"
          git config user.email "astroturf-bot@users.noreply.github.com"
      - name: Sow Synthetic Seeds
        id: turf
        uses: ./.github/actions/astroturf
      - name: Commit and Push (if the crowd shows up)
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            git add -A
            git commit -m "${{ steps.turf.outputs.commit_message }}"
            git push
          else
            echo "No changes to commit."
          fi
      - name: Announce Push (Chaos Mode vibes?)
        if: ${{ (github.ref_name == 'main' || github.ref_name == 'master') }}
        uses: actions/github-script@v7
        env:
          TURF_COMMIT_MESSAGE: ${{ steps.turf.outputs.commit_message }}
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const sha = context.sha;
            // Fetch last commit details
            const { data: commit } = await github.rest.repos.getCommit({ owner, repo, ref: sha });
            const lastMessage = commit.commit.message || '';
            // Only comment if this run actually committed using the turf message
            if (lastMessage.trim() === (process.env.TURF_COMMIT_MESSAGE || '').trim()) {
              await github.rest.repos.createCommitComment({
                owner,
                repo,
                commit_sha: sha,
                body: [
                  'üß™ CHAOS MODE ADJACENT: The Astroturf bot just pushed straight to ' + context.ref + '.',
                  '',
                  'Relax, this is a scheduled top-up of synthetic enthusiasm. If you were expecting a PR,',
                  'consider this the ‚Äúdirector‚Äôs cut‚Äù where we skip review for dramatic effect.'
                ].join('\n')
              });
            }