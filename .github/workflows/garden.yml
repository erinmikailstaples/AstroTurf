name: Garden Keeper: Photosynthesis-as-a-Service

on:
  schedule:
    - cron: '17 9 * * *'
  push:
    branches: [ main, master ]
    paths:
      - 'lawn-health.json'
  issues:
    types: [opened, closed]
  pull_request:
    types: [opened, closed]

permissions:
  contents: write

jobs:
  tend-garden:
    name: Tend the Garden (Weed out entropy)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (watering can not included)
        uses: actions/checkout@v4

      - name: Setup Python (snake charming)
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Dependencies (miracle grow edition)
        run: |
          python -m pip install --upgrade pip
          pip install pillow

      - name: Run Garden Script (watch the weeds whisper)
        env:
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
        run: |
          python scripts/garden_bot.py

      - name: PR Theatrics (play up the absurdity)
        if: ${{ github.event_name == 'pull_request' }}
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            if (!pr) return;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              body: [
                'üå± Behold: automated horticulture has entered the chat.',
                '',
                'This check ensures the garden is immaculately chaotic. If anything fails,',
                'assume the weeds unionized and demand better sunlight.'
              ].join('\n')
            });

      - name: Commit and Push Changes (embrace the mulch)
        run: |
          git config user.name "garden-bot"
          git config user.email "garden-bot@users.noreply.github.com"
          git add garden.md garden.svg lawn-health.json seedlings weeds || true
          if ! git diff --cached --quiet; then
            git commit -m "chore(garden): refresh story and image"
            git push
          fi

      - name: Chaos Mode Confessional (direct push to main/master)
        if: ${{ github.event_name == 'push' && (github.ref_name == 'main' || github.ref_name == 'master') }}
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: [
                '‚ö†Ô∏è CHAOS MODE: This was merged directly from main/master.',
                '',
                'No detours through a branch. No PR velvet rope. Just raw chlorophyll energy.',
                'Proceed knowing that reviewers were bypassed in service of speed and spectacle.'
              ].join('\n')
            });
